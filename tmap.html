<html>
  <head>
  <title>TMap</title>
	<link href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css" rel="stylesheet" title="data tables"/>
	<!-- <base href="http://willallencoding.scienceontheweb.net/"></base> -->
	<style type="text/css">
	  body { background-color: #ddd; font-family:arial; font-size:12}
	  #container { height: 80%; width: 100%; display: table; }
	  #inner { vertical-align: middle; display: table-cell; }
	  #map { width: 100%; height:80%; margin: 0 auto; }
	</style>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
	<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCg7dti-2ObZtnU9z_-5teyfyLCUajMur4&signed_in=true&callback=initMap"></script>
	<script type='text/javascript'>

	//<https://code.jquery.com/jquery-1.10.2.js
	//#map { width: 360px; height:200px; margin: 0 auto; }
	// set your channel id here
	var channel_id = 39919;
	// set your channel's read api key here if necessary
	var api_key = 'FSOH5JIDQ8N52Q3V';
	var NRESULTS = 2000;
	// global variables
	var map, data, previousLoc = {lat:0,lng:0}, nCount=0;
	var sImagePath = "./images/";
	var sTPURL = 'https://api.thingspeak.com/channels/39919/feeds.json?timezone=America%2FNew_York&round=6&results='
		+NRESULTS + '&api_key=' + api_key;
	var oFields = {ODOMETER: "field3", IDEAL_RANGE:"field6", ESTIMATED_RANGE:"field5", BATTERY_LEVEL:"field1", LATITUDE:"field7", LONGITUDE:"field8", SPEED:"field2"};
	/*
	oFields.ODOMETER
	oFields.IDEAL_RANGE
	oFields.ESTIMATED_RANGE
	oFields.BATTERY_LEVEL
	oFields.LATITUDE
	oFields.LONGITUDE
	oFields.SPEED
	*/
	
	
	var oIcons = {0:"stopped.png", 1:"car_01.png", 2:"car_02.png", 3:"car_03.png",
				  4:"car_04.png", 5:"car_05.png", 5:"car_06.png",
				  6:"car_06.png", 7:"car_07.png", 8:"car_08.png",
				  9:"car_09.png", 10:"car_10.png", 
				  stopped:"stopped.png", moving:"moving.png"}
	
function loadFeed()
{
	$.getJSON(sTPURL, function(data)
	{
		var nCnt = 0;
		var nMarkersDrawn= 0;
		var nDataPoints = 0;
		var nMaxSpeed = 0;
		var oMarkers = {};
		var oCurrentPosMark = null;
		var sLastLocation = "";
		var ntBegin = Date.now();	//look for earlest date, starting with now
		var ntEnd = 0;	//look for latest date, starting with something early
		$.each(data.feeds, function() 
		{
			var nLat = parseFloat(this[oFields.LATITUDE]);
			var nLng = parseFloat(this[oFields.LONGITUDE]);
			var nSpeed = parseFloat(this[oFields.SPEED]);
			nSpeed = (nSpeed) ? nSpeed : 0;
			nMaxSpeed = Math.max(nSpeed, nMaxSpeed);
			
			var oDate = new Date(this["created_at"]);
			var nTime = oDate.getTime();
			if(nTime < ntBegin){ntBegin = nTime}
			if(nTime > ntEnd){ntEnd = nTime}
			
			//break;
			if(nLat && nLng  )
			{
				var sLoc = Math.round(nLat*1000)+""+Math.round(nLng*1000);
				var sDateString = oDate.toDateString();
				sLastLocation = sLoc;
				nDataPoints++;
				if(oMarkers[sLoc])
				{
					//only count 1x per day, and dont bother adding more than 10 dates
					if(!oMarkers[sLoc].hDates[sDateString] && oMarkers[sLoc].nCnt <= 10)	
					{
						oMarkers[sLoc].nCnt = oMarkers[sLoc].nCnt+1;
						oMarkers[sLoc].hDates[sDateString] = true;
						oMarkers[sLoc].title = oMarkers[sLoc].title + '\n' + sDateString;
					}
				}
				else
				{
					var ohDates = {};
					ohDates[sDateString] = true;
					oMarkers[sLoc] = {position:{lat: nLat, lng: nLng}, title:sDateString, hDates: ohDates, speed: nSpeed, nCnt:1};
				}
			}
		})
		
		for(var x in oMarkers)
		{
			var oMark = oMarkers[x];
			nMarkersDrawn++;
			if(sLastLocation == x)
			{
				oCurrentPosMark = oMark;
			}
			else if(oMark.speed > 0)
			{
				var marker = new google.maps.Marker({
					map: map,
					icon: sImagePath + oIcons["moving"],
					position: oMark.position,
					title: oMark.title
					});
			}
			else if(oMark.nCnt > 10)
			{
				var marker = new google.maps.Marker({
					map: map,
					icon: sImagePath + oIcons[10],
					position: oMark.position,
					title: oMark.title
					});
			}
			else
			{
				var marker = new google.maps.Marker({
					map: map,
					icon: sImagePath + oIcons[oMark.nCnt],
					position: oMark.position,
					title: oMark.title
					});
			}
		}

		//draw it last, to be sure it sits OVER any other markers
		var marker = new google.maps.Marker({
				map: map,
				icon: sImagePath + oIcons["stopped"],
				position: oCurrentPosMark.position,
				title: oCurrentPosMark.title + " moving:" + oCurrentPosMark.speed
				});

		var dEarliest = new Date(ntBegin);
		var dLatest = (new Date(ntEnd));
		$("#debug").append("<li>Number of Markers:" + nMarkersDrawn + " out of " + nDataPoints 
			+"<br><b>Note</b> that program only shows unique markers</br></li>");
		$("#debug").append("<li>Max speed:" + nMaxSpeed +"</li>");
		if(dEarliest && dLatest)
		{
			$("#debug").append("<li>Date Range:" + (dEarliest.toDateString()) + " to " + (dLatest.toDateString()) +"</li>");
		}
	})
}

function computeAge()
{
/*
Valid parameters:
api_key (string) Read API Key for this specific Channel (optional--no key required for public channels)
results (integer) Number of entries to retrieve, 8000 max, default of 100 (optional)
days (integer) Number of 24-hour periods before now to include in feed (optional)
start (datetime) Start date in format YYYY-MM-DD%20HH:NN:SS (optional)
end (datetime) End date in format YYYY-MM-DD%20HH:NN:SS (optional)
timezone (string) Timezone identifier for this request (optional)
offset (integer) Timezone offset that results should be displayed in. Please use the timezone parameter for greater accuracy. (optional)
status (true/false) Include status updates in feed by setting "status=true" (optional)
metadata (true/false) Include Channel's metadata by setting "metadata=true" (optional)
location (true/false) Include latitude, longitude, and elevation in feed by setting "location=true" (optional)
min (decimal) Minimum value to include in response (optional)
max (decimal) Maximum value to include in response (optional)
round (integer) Round to this many decimal places (optional)
-----timescale (integer or string) Get first value in this many minutes, valid values: 10, 15, 20, 30, 60, 240, 720, 1440, "daily" (optional)
sum (integer or string) Get sum of this many minutes, valid values: 10, 15, 20, 30, 60, 240, 720, 1440, "daily" (optional)
average (integer or string) Get average of this many minutes, valid values: 10, 15, 20, 30, 60, 240, 720, 1440, "daily" (optional)
median (integer or string) Get median of this many minutes, valid values: 10, 15, 20, 30, 60, 240, 720, 1440, "daily" (optional)
callback (string) Function name to be used for JSONP cross-domain requests (optional)
*/

	var sURL = 'https://api.thingspeak.com/channels/'+channel_id+'/feeds.json?location=false&status=false&timescale=240&round=6&results=3000&api_key='+api_key;
	$.getJSON(sURL, 
	function(data)
	{
		var NINTERVALSPERDAY = 6;
		var nPrevI = 276;	//initial rated ideal range
		var nPrevE = 240;	//initial rated expected range
		var SKIPDAYS=3;
		var nIntervals = SKIPDAYS * NINTERVALSPERDAY;
		var nSkipper = 0;
		var oAvgIdeal = {sum:0, cnt:0};
		var oAvgEst = {sum:0, cnt:0};
		var items = [[" - Initial", nPrevI, "N/A", nPrevE,  "N/A", "0"]];
	$.each(data.feeds, function() 
	{
		var nIdealRange = parseFloat(this[oFields.IDEAL_RANGE]);
		var nOdometer = parseFloat(this[oFields.ODOMETER]);
        var nEstRange = parseFloat(this[oFields.ESTIMATED_RANGE]);
		var nBattLevel = parseFloat(this[oFields.BATTERY_LEVEL]);
		//check if valid
		if(nBattLevel && nIdealRange && nBattLevel)	//all should be non-0 and !NAN
		{
			//write a record every "interval" - SKIPDAYS, otherwise take average
			oAvgIdeal.sum =  oAvgIdeal.sum + getRange(nIdealRange, nBattLevel);
			oAvgIdeal.cnt = oAvgIdeal.cnt + 1;

			oAvgEst.sum =  oAvgEst.sum + getRange(nEstRange, nBattLevel);
			oAvgEst.cnt = oAvgEst.cnt + 1;

			if((nSkipper++ == nIntervals) )
			{
				nSkipper=0;
				var nPerI = oAvgIdeal.sum / oAvgIdeal.cnt;
				var nPerE = oAvgEst.sum / oAvgEst.cnt
				var sLossI = round2(100 * (nPrevI-nPerI)/nPerI)+"%"
				var sLossE = round2( 100 * (nPrevE-nPerE)/nPerE )+"%"
				var sDate = (this["created_at"] + "").substring(0,10);
				items.push( [sDate,round2(nPerI), sLossI, round2(nPerE), sLossE, round2(nOdometer)] );
			
				//hold the previous values
				nPrevI = nPerI;
				nPrevE = nPerE;
				
				//reset averages
				oAvgIdeal = {sum:0, cnt:0};
				oAvgEst = {sum:0, cnt:0};
			}
		}
	})

	   $('#batteryTable').DataTable( {
        data: items,
        columns: [
            { title: "Date - ("+SKIPDAYS+") day averages"  },
            { title: "Ideal Range" },
            { title: "Ideal Range loss" },
            { title: "Est. Range" },
            { title: "Estimated Range Loss" },
			{ title: "Odometer (miles)" }
        ]
    } );
	
	//work out overall loss
	//compute the the average of the early range values and most recent, to see consistency in the losses
	var oAvgRangeEarly = {sum:0, cnt:0};
	var oAvgRangeLate = {sum:0, cnt:0};
	var nRecordsToAverage = 4;
	var nPosOfRangeEstimated = 3;
	for (var x = items.length-1; x >=0; x-- )
	{
		if(x < nRecordsToAverage)
		{
			oAvgRangeEarly.cnt = oAvgRangeEarly.cnt + 1;
			oAvgRangeEarly.sum = oAvgRangeEarly.sum + items[x][nPosOfRangeEstimated];
		}
		if(x > items.length - nRecordsToAverage)
		{
			oAvgRangeLate.cnt = oAvgRangeLate.cnt + 1;
			oAvgRangeLate.sum = oAvgRangeLate.sum + items[x][nPosOfRangeEstimated];
		}
		//$("#debug").append("<li>blah" + items[x][nPosOfRangeEstimated] + ", "+oAvgRangeLate.sum +"</li>");
	}
	var fCurrentRangeAvg = oAvgRangeLate.sum / oAvgRangeLate.cnt; 
	var fOriginalRangeAvg = (oAvgRangeEarly.sum/ oAvgRangeEarly.cnt)
	var fEstRangeLoss = round2((fOriginalRangeAvg-fCurrentRangeAvg)/fOriginalRangeAvg*100);
	
	$("#debug").append("<li>Overall Est Range Loss: " + fEstRangeLoss +"%."
		+"  (Current: "+round2(fCurrentRangeAvg)+ " Original: "+ round2(fOriginalRangeAvg) + ")</li>");
	})
}

	function round2(dVal)
	{
		return Math.round( 100 * dVal )/100;
	}
	function getRange(nCurrRange, nLevel)
	{
		return nCurrRange / (nLevel*.01);
	}

 function initMap() 
 {
  // Create a map object and specify the DOM element for display.
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 38.92, lng: -77.27879},
    scrollwheel: true,
    zoom: 9
  });
  loadFeed();
  computeAge();
}

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-550134-9', 'scienceontheweb.net');
  ga('send', 'pageview');


</script>
</head>

	<body>
		<div id="map"></div>
		<div id="rangeTable"><table id="batteryTable" class="display" width="80%"></table></div>
		<ul id="debug"></ul>
	</body>
</html>
