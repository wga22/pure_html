
<html>
  <head>
  <title>Bitcoin Mining operations</title>
<style type="text/css">
  body { background-color: #eeeeee; }
  #container { height: 95%; width: 100%; display: table; }
  #inner { vertical-align: middle; display: table-cell; }
  #btc_results_table{ background-color:lightblue;}
</style>
	<link href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css" rel="stylesheet" title="data tables"/>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>

	<script type='text/javascript'>

	//<https://code.jquery.com/jquery-1.10.2.js
	//#map { width: 360px; height:200px; margin: 0 auto; }
	// set your channel id here
	var channel_id = 89240;
	// set your channel's read api key here if necessary
	var api_key = '5EYUC2WVZN0T2ALY';
	// global variables
	var NMONTHSTOLOAD = 24;
	//var MILLISPERMONTH = 31*24*60*60*1000; //days*hours*mins*secs*millis
	var sURLRate = "https://blockchain.info/q/24hrprice";
	var DIFFURL = "https://blockchain.info/q/getdifficulty"
	var sTPURL = 'https://api.thingspeak.com/channels/'+channel_id+'/feeds.json?timezone=America%2FNew_York&api_key='+api_key;
	var oFields = {BALANCE: "field1", HRHASHRATE: "field2", DIFFICULTY: "field3"};
	var nLoadedMonths = 1;
	var oMonthlyBTCValues = {};
	var NBTCFACTOR = 0.00000001
	var nConversion = 0;

	function getDateToTSStringFirstDay(a_oDate)
	{
		//YYYY-MM-DD%20HH:NN:SS
		if(!a_oDate)
		{
			a_oDate = new Date();
		}
		var sMonth = (a_oDate.getMonth() + 1);
		sMonth = (sMonth < 10)? ("0"+sMonth) : (sMonth + "");
		return (a_oDate.getFullYear()+0) + "-" + sMonth + "-01%2000:00:00"
	}

	function loadMissingFeb2016Data()
	{
		//test to see if feb 2016 still relevant, by looking at current dates
		var dFeb2016 = new Date(2016, 1,1);
		//find out date of oldest data that would be loaded
		var dOldest = new Date();
		dOldest.setMonth(dOldest.getMonth() - NMONTHSTOLOAD);
		$('#debug').append("<li>"+dOldest.toDateString()+" " + dFeb2016.toDateString() +"</li>");
		if(dFeb2016.getTime() > dOldest.getTime())
		{
			var sYM = "2016-2";
			oMonthlyBTCValues[sYM] = new BTCResults();
			for(var y = 0; y < 50; y++)
			{
				//we dont care much about accuracy of the data, just want to get reasonable averages
				oMonthlyBTCValues[sYM].addVals(10,4070461533910);
			}
		}
	}
function loadAllTheData()
{
	//determine the monthly average daily temperature difference when attic is hotter than outside
	loadMissingFeb2016Data();
	var oMonthToLoad = new Date();
	oMonthToLoad.setMonth(oMonthToLoad.getMonth()+1);	//increment the date one month forward
	for(var x=0; x < NMONTHSTOLOAD; x++)
	{
		//  start (datetime) Start date in format YYYY-MM-DD%20HH:NN:SS (optional) (stop is the same)
		var sStopDate = getDateToTSStringFirstDay(oMonthToLoad);
		var sYM = (1902+oMonthToLoad.getYear()) + "-" + (oMonthToLoad.getMonth()-1)
		oMonthToLoad.setMonth(oMonthToLoad.getMonth()-1)
		var sTPURLbyDate =  sTPURL+ "&start=" + getDateToTSStringFirstDay(oMonthToLoad) + "&end=" + sStopDate;
		//$('#debug').append("<li>"+sTPURLbyDate+"</li>");
		
		$.getJSON(sTPURLbyDate, function(data)
		{
			$.each(data.feeds, function() 
			{
				var nBalance = parseFloat(this[oFields.BALANCE]);	//balance
				var nHashRate = parseFloat(this[oFields.HRHASHRATE]); //hourly hash rate
				var nDifficulty = parseFloat(this[oFields.DIFFICULTY]); //difficulty - not in original dataset
				//efficiency move var time = new Date(this["created_at"]);
				//$('#debug').append("<li>"+nAtticT+"</li>");
				//var time = this["created_at"]
				if(nBalance >=0 && nHashRate>=-100 )
				{
					//efficiency move var sYM = time.getFullYear() + "-" + (time.getMonth()+1);					
					if(!oMonthlyBTCValues[sYM])
					{
						oMonthlyBTCValues[sYM] = new BTCResults();
					}
					oMonthlyBTCValues[sYM].addVals(nBalance,nHashRate);
					//$('#debug').append("<li>FOUND"+nBalance+"</li>");
				}
				//$('#debug').append("<li> not!? "+nBalance+ " xx " +nHashRate +"</li>");
			})
			//inside the call
			nLoadedMonths++;
		}	
		) //getJSON
	}	// for loop
}

function writeTheValues(oVals, sTable)
	{
	//compute the averages for each month, and write it to a dataset for output to a table.
	var aDeltasPerMonth = [];
	for (var x in oVals)
	{
		//$('#debug').append("<li>loading month: "+x+"</li>");
		
		var od = oVals[x];
		var nEarned = od.balanceGrowth()
		aDeltasPerMonth.push([x,
			("$" + round2(od.maxBal*nConversion)), 
			("$" + round2(nEarned * nConversion)),
			round2(nEarned),
			(round2(od.avgHourlyHashRate(true))),
			(round2(od.percentRunning() * 100) + "%"),
			("$" + round2(od.revPerHour()*nConversion)),
			(od.difficultyIncrease()),
			od.nCount]);
	}

	//write out the table
	$(sTable).DataTable( {
        data: aDeltasPerMonth,
        columns: [
            { title: "Date" },
            { title: "Bal USD" },
			{ title: "Earned USD" },
			{ title: "Earned BTC" },
			{ title: "Average Hashrate (THs)" },
			{ title: "Time Running" },
			{ title: "Rev per hour running" },
			{ title: "Diff Increase"},
            { title: "# Collected" }
        ]
    } );
}

 function round2(nNum)
 {
	return Math.round(nNum * 100)/100;
 }
 
 function waitAndWriteVals()
 {
	
	if(nLoadedMonths >= NMONTHSTOLOAD && nConversion > 0)
	{
		//writeTheValues();
		writeTheValues(oMonthlyBTCValues, "#btc_results_table");
	}
	else
	{
		$('#debug').append("<li>Waiting.  Loaded so far "+nLoadedMonths+" months of data.</li>")
		setTimeout("waitAndWriteVals()", 2000);
	}
 }
 function getBTCRate()
 {
	$.get( sURLRate, function( data ) 
	{
	$('#debug').append("<li>BTC Price: "+data+"</li>");
	nConversion = parseFloat(data) * NBTCFACTOR;
	});
}

function getDifficulty()
{
	//163491654908.95926 / 1.6349165490895926E11
	$.get( DIFFURL, function( data ) 
	{
		var nDiff = parseFloat(data)
		$('#debug').append("<li>DIFF:"+data+" " + nDiff + "</li>");
	});
}
 function main() 
 {
	getBTCRate();
	//getDifficulty();
	loadAllTheData();
	waitAndWriteVals();
	//setTimeout("waitAndWriteVals()", 20000);
	//setTimeout("writeTheValues()", 20000);
 }

 function BTCResults()
 {
	var THSDIGITS = 1000000000000;
	this.maxBal=0;
	this.minBal=9999999999;
	this.hourlyHashRate = 0;
	this.balance = 0;
	this.nCount = 0;
	this.nCountRunning = 0;
	
	//functions
	this.addVals = _addVals;
	this.balanceGrowth = _balanceGrowth;
	this.avgHourlyHashRate = _avgHourlyHashRate;
	this.percentRunning = _perRunning;
	this.revPerHour = _revBTCPerHour;
	this.difficultyIncrease = _difficultyIncrease;
	
	function _difficultyIncrease()
	{
		return 0;
	}
	
	function _revBTCPerHour()
	{
		//return _balanceGrowth() / this.nCountRunning
		return (this.maxBal - this.minBal) / this.nCountRunning
	}
	
	function _perRunning()
	{
		return this.nCountRunning / this.nCount;
	}
	
	function _average(nSum, nCnt)
	{
		return nSum / nCnt;
	}
	
	function _balanceGrowth()
	{
		return this.maxBal - this.minBal;
	}
	function _avgHourlyHashRate(fInThs)
	{
		return _average(this.hourlyHashRate/THSDIGITS,this.nCount)
	}
	
	function _addVals(nBal, nRate)
	{
		if(validnum(nRate))
		{
			if(nRate > 0)
			{
				this.nCountRunning++
			}
			this.hourlyHashRate += nRate;
		}
		if(validnum(nBal))
		{
			//UNUSED this.balance += nBal;
			this.minBal = Math.min(nBal, this.minBal);
			this.maxBal = Math.max(nBal, this.maxBal);
	
		}
		this.nCount++;
	}
	function validnum(nVal)
	{
		return !isNaN(nVal) && (null != nVal)
	}
 }
 
 /*
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-550134-9', 'scienceontheweb.net');
  ga('send', 'pageview');
*/
</script>
</head>

  <body onload="main()">
  <p>
	This page provides details on BTC mining operations.
  </p>
<div class="summer">Computations
	<table id="btc_results_table" class="display" width="80%"></table>
</div>

	<ol id="debug">
	</ol>
</body>
</html>
